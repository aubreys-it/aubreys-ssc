<link rel="import" href="../../bower_components/polymer/polymer.html">
<dom-module id="Generate-Schedule">
    <template>
        <iframe id="ScheduleReport" src="" hidden></iframe>
        <!-- <h2 class="page-title">{{schedule-list.result}}</h2> -->
        <paper-toolbar>
            <iron-icon style="" icon="notification:event-available"></iron-icon>
            <div style="margin-left: 10px;" class="title">Schedule View</div>
            <paper-spinner style="margin-left:250px; position: absolute;" id="spinner"></paper-spinner>
            <iron-label>
                Select Previous Schedule:
                <paper-dropdown-menu id="FileSelector" on-iron-select="ChangeFile" style="margin-left:20px; width:220px;">
                    <paper-menu class="dropdown-content" selected="0">
                        <template is="dom-repeat" items="{{scheduleList.data}}" as="sched">
                            <paper-item value="{{index}}">{{sched.from_date}} TO {{sched.to_date}}</paper-item>
                        </template>
                    </paper-menu>
                </paper-dropdown-menu>
            </iron-label>

            <paper-spinner style="margin-left:250px; position: absolute;" id="spinner"></paper-spinner>



        </paper-toolbar>

        <div style=" display: flex;align-items: center; justify-content: center">
            <iframe id="Frame" src="" style="border: 0;margin-top:20px;" onload="resizeIframe(this)" seamless></iframe>
        </div>

        <div style="z-index:20;position:fixed; bottom:5%;right:5%;">
            <paper-fab-speed-dial direction="top">
                <paper-fab success icon="menu" class="dropdown-trigger"></paper-fab>
                <div class="dropdown-content">
                    <paper-fab title="Print Report" mini icon="icons:assessment" info on-tap="PrintSchedReport"></paper-fab>
                    <paper-fab mini warning dialog="AskEmail" label="Email Schedules" on-tap="showDialog" icon="communication:email" title="Email Schedule"></paper-fab>
                    <paper-fab title="Print Schedule" mini icon="print" info on-tap="print"></paper-fab>
                </div>
            </paper-fab-speed-dial>
        </div>


        <paper-dialog id="AskEmail" entry-animation="scale-up-animation" exit-animation="fade-out-animation" modal with-backdrop>
            <h2>Email Schedule</h2>
            <p> Are you sure you are ready to email the latest schedule?</p>
            <div class="buttons">
                <paper-button email="false" dialog-dismiss>NO</paper-button>
                <paper-button email="true" on-tap="EmailSchedule" autofocus dialog-confirm>YES</paper-button>
            </div>
        </paper-dialog>

        <iron-ajax id="GetData" url="/api/schedule/list" handle-as="json" on-error="GetRequestFail" on-response="SetscheduleList"
            method="GET" debounce-duration="300">
        </iron-ajax>
        <iron-ajax id="SendEmail" url="/api/email/schedule" handle-as="json" on-response="RequestComplete" method="POST" debounce-duration="300">
        </iron-ajax>

    </template>

    <script>
        function resizeIframe(obj) {
            obj.style.height = (obj.contentWindow.document.body.scrollHeight + 50) + 'px';
            obj.style.width = (obj.contentWindow.document.body.scrollWidth + 20) + 'px';
        };

        Polymer({
            is: 'Generate-Schedule',
            Properties: {
                CurrentFile: {
                    type: String
                },
                scheduleList: {
                    type: Array
                }
            },
            ready: function () {
                app.PageLoading = false;
                this.$.spinner.active = true;
                this.$.GetData.generateRequest();
            },
            PrintSchedReport: function () {
                this.$.ScheduleReport.src = "/api/schedule/report?rand=" + Math.round(Math.random() *
                    10000000);
            },
            toTop: function () {
                this.$.FileSelector.scrollIntoView({
                    block: "end",
                    behavior: "smooth"
                });
            },
            SetscheduleList: function (data) {
                this.scheduleList = data.detail.response;
                this.$.spinner.active = false;
            },
            GetRequestFail: function () {
                app.$.toast.text = "Unable to connect to server, trying again in 5 seconds.";
                app.$.toast.show();
                this.$.spinner.active = false;
                this.async(function () {
                    this.$.spinner.active = true;
                    this.$.GetData.generateRequest();
                }, 5000);
            },
            ChangeFile: function (e) {
                this.CurrentFile = e.target.selectedItem.value;
                if (this.CurrentFile == 0) {
                    this.$.Frame.src = "/api/schedule"
                } else {
                    this.$.Frame.src = "/api/schedule/" + this.scheduleList.data[this.CurrentFile].id;
                }
            },
            EmailSchedule: function () {
                app.$.toast.text = "Schedules Sent"
                this.$.SendEmail.generateRequest();
                this.$.spinner.active = true;
            },
            RequestComplete: function (data) {
                if (data.detail.response.result != 'success') {
                    app.$.toast.text = "error: " + data.detail.response.log;
                } else {

                }
                app.$.toast.show();
                this.$.spinner.active = false;
            },
            showDialog: function (e, detail) {
                var button = e.target;
                button = button.parentElement;
                var dialog = button.getAttribute('dialog');
                if (!dialog) {
                    dialog = e.target.getAttribute('dialog');
                };
                this.$$("#" + dialog).toggle()
            },
            print: function () {
                var frm = document.getElementById("Frame").contentWindow;
                frm.focus(); // focus on contentWindow is needed on some ie versions
                frm.print();
            }
        });
    </script>

</dom-module>