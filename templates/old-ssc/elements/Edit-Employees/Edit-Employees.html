<!--
Author: Cody James
This web application has been created for use by Aubrey's Restaurants,
any unlicensed use by Aubrey's or any other Individuals/Groups/Companys
is not permitted; and those Individuals/Groups/Companys will be prosecuted.
Copyright (c) 2016 Cody James All Rights Reserved.
-->


<link rel="import" href="../../bower_components/polymer/polymer.html">
<dom-module id="Edit-Employees">
    <link rel="import" href="../../bower_components/iron-icons/communication-icons.html">
    <template id="scope">
        <style>
            .checkbox-box paper-checkbox,
            .checkbox-box label {
                margin-right: 10px;
            }

            .checkbox-box {
                margin-top: 20px;
            }

            .MenuButton {


                /*margin-bottom: 5%;*/
                max-height: 200px;
                /* approximate max height */
                z-index: 206;
                position: fixed;
                bottom: 5%;
                right: 5%;
                transition-property: all;
                transition-duration: .8s;
                opacity: 100%;
            }

            .CancelButton {
                z-index: 200;
                position: fixed;
                bottom: 5%;
                right: 5%;
                transition-property: all;
                transition-duration: .9s;
                transform: translate(-22%, -160%);
            }

            .CancelButton.closed {
                bottom: 120%;
            }

            .SaveButton {
                overflow: hidden;

                /*margin-bottom: 5%;*/
                max-height: 200px;
                /* approximate max height */
                z-index: 206;
                position: fixed;
                bottom: 5%;
                right: 5%;

                transition-property: all;
                transition-duration: .9s;
            }

            .SaveButton.closed,
            .MenuButton.closed {
                bottom: -20%;
            }
        </style>


        <div>
            <!--
████████  ██████   ██████  ██      ██████   █████  ██████
   ██    ██    ██ ██    ██ ██      ██   ██ ██   ██ ██   ██
   ██    ██    ██ ██    ██ ██      ██████  ███████ ██████
   ██    ██    ██ ██    ██ ██      ██   ██ ██   ██ ██   ██
   ██     ██████   ██████  ███████ ██████  ██   ██ ██   ██
-->


            <paper-toolbar>
                <iron-icon style="" icon="social:people"></iron-icon>
                <div style="margin-left: 10px;" class="title">Manage Employees</div>
                <paper-spinner style="margin-left:250px; position: absolute;" id="spinner"></paper-spinner>
                <paper-input tabindex="0" style="width: 300px;" type="search" autofocus="true" id="SearchBox" label="Search Employees" value="{{searchString::input}}"></paper-input>


            </paper-toolbar>

            <!--

███████ ███    ███ ██████  ██       ██████  ██    ██ ███████ ███████     ████████ ███████ ███    ███ ██████  ██       █████  ████████ ███████
██      ████  ████ ██   ██ ██      ██    ██  ██  ██  ██      ██             ██    ██      ████  ████ ██   ██ ██      ██   ██    ██    ██
█████   ██ ████ ██ ██████  ██      ██    ██   ████   █████   █████          ██    █████   ██ ████ ██ ██████  ██      ███████    ██    █████
██      ██  ██  ██ ██      ██      ██    ██    ██    ██      ██             ██    ██      ██  ██  ██ ██      ██      ██   ██    ██    ██
███████ ██      ██ ██      ███████  ██████     ██    ███████ ███████        ██    ███████ ██      ██ ██      ███████ ██   ██    ██    ███████

-->

            <!-- Begin Employee Repeat Template -->
            <template is="dom-repeat" items="{{Employees.data}}" as="emp" filter="{{computeFilter(searchString)}}" id="EmployeeTemplate">

                <!-- Main Employee Card -->

                <paper-card class="" elevation="1" style="width:100%;margin-top:10px;" secondary onfocusin="hoverOver(this)" onfocusout="hoverOut(this)"
                    animatedShadow="true">
                    <div class="card-content">
                        <paper-input id="name" label="Name" value="{{emp.employee_name}}"></paper-input>
                        <gold-email-input auto-validate error-message="Please enter a valid email!" id="email-{{emp.ID}}" label="Email" value="{{emp.employee_email}}"></gold-email-input>
                        <paper-input type="j" pattern="^[2-9]\d{2}-\d{3}-\d{4}$" error-message="Phone Number Must Be In xxx-xxx-xxxx format!" auto-validate
                            id="phone-{{emp.ID}}" label="Phone Number" value="{{emp.employee_phone}}"></paper-input>
                        <paper-input id="ABC-{{emp.ID}}" label="ABC Expiration Date" always-float-label type="date" value="{{emp.employee_abc_expiration_date}}"></paper-input>
                        <paper-input id="BookLocation-{{emp.ID}}" label="ABC Book Location" value="{{emp.employee_abc_book_location}}"></paper-input>


                        <div class="checkbox-box layout horizontal wrap">
                            <label>AM: </label>

                            <paper-checkbox id="AM_Monday{{emp.ID}}" checked="{{emp.shifts_am.1}}">Monday</paper-checkbox>
                            <paper-checkbox id="AM_Tuesday{{emp.ID}}" checked="{{emp.shifts_am.2}}">Tuesday</paper-checkbox>
                            <paper-checkbox id="AM_Wednesday{{emp.ID}}" checked="{{emp.shifts_am.3}}">Wednesday</paper-checkbox>
                            <paper-checkbox id="AM_Thursday{{emp.ID}}" checked="{{emp.shifts_am.4}}">Thursday</paper-checkbox>
                            <paper-checkbox id="AM_Friday{{emp.ID}}" checked="{{emp.shifts_am.5}}">Friday</paper-checkbox>
                            <paper-checkbox id="AM_Saturday{{emp.ID}}" checked="{{emp.shifts_am.6}}">Saturday</paper-checkbox>
                            <paper-checkbox id="AM_Sunday{{emp.ID}}" checked="{{emp.shifts_am.7}}">Sunday</paper-checkbox>
                        </div>
                        <hr>

                        <div class="checkbox-box layout horizontal wrap">
                            <label>PM: </label>

                            <paper-checkbox id="PM-Monday{{emp.ID}}" checked="{{emp.shifts_pm.1}}">Monday</paper-checkbox>
                            <paper-checkbox id="PM_Tuesday{{emp.ID}}" checked="{{emp.shifts_pm.2}}">Tuesday</paper-checkbox>
                            <paper-checkbox id="PM_Wednesday{{emp.ID}}" checked="{{emp.shifts_pm.3}}">Wednesday</paper-checkbox>
                            <paper-checkbox id="PM_Thursday{{emp.ID}}" checked="{{emp.shifts_pm.4}}">Thursday</paper-checkbox>
                            <paper-checkbox id="PM_Friday{{emp.ID}}" checked="{{emp.shifts_pm.5}}">Friday</paper-checkbox>
                            <paper-checkbox id="PM_Saturday{{emp.ID}}" checked="{{emp.shifts_pm.6}}">Saturday</paper-checkbox>
                            <paper-checkbox id="PM_Sunday{{emp.ID}}" checked="{{emp.shifts_pm.7}}">Sunday</paper-checkbox>
                        </div>
                        <hr>
                </paper-card>
                </div>
                <div class="card-actions">
                    <paper-icon-button raised error id="{{emp.id}}" icon="icons:delete" onclick="deleteClick(event)" data-dialog="AskDelete"
                        style="float:left;"></paper-icon-button>
                    <!-- <paper-button success style="float:right;" on-tap="UpdateInfo"><iron-icon icon="icons:done"></iron-icon> Submit Update</paper-button> -->
                    <div style="float: right; color:grey;">
                        {{emp.employee_name}}
                    </div>
                </div>
                </paper-card>


                <!-- Temporary Storage for id of employee to be deleted ##workaround## -->
                <label hidden id="did"></label>


                <!-- End Repeat Template -->
            </template>

            <!--
            ██████  ███████ ██      ███████ ████████ ███████     ██████  ██  █████  ██       ██████   ██████
            ██   ██ ██      ██      ██         ██    ██          ██   ██ ██ ██   ██ ██      ██    ██ ██
            ██   ██ █████   ██      █████      ██    █████       ██   ██ ██ ███████ ██      ██    ██ ██   ███
            ██   ██ ██      ██      ██         ██    ██          ██   ██ ██ ██   ██ ██      ██    ██ ██    ██
            ██████  ███████ ███████ ███████    ██    ███████     ██████  ██ ██   ██ ███████  ██████   ██████
            -->
            <paper-dialog id="AskDelete" entry-animation="scale-up-animation" exit-animation="fade-out-animation" with-backdrop>
                <h2>DELETE EMPLOYEE</h2>
                <P>
                    Are you sure you want to delete this employee?
                </P>

                <div class="buttons">
                    <paper-button autofocus dialog-dismiss>NO</paper-button>
                    <paper-button on-click="Delete" dialog-confirm>YES</paper-button>
                </div>
            </paper-dialog>

            <!--
            ███    ██ ███████ ██     ██     ███████ ███    ███ ██████  ██       ██████  ██    ██ ███████ ███████     ██████  ██  █████  ██       ██████   ██████
            ████   ██ ██      ██     ██     ██      ████  ████ ██   ██ ██      ██    ██  ██  ██  ██      ██          ██   ██ ██ ██   ██ ██      ██    ██ ██
            ██ ██  ██ █████   ██  █  ██     █████   ██ ████ ██ ██████  ██      ██    ██   ████   █████   █████       ██   ██ ██ ███████ ██      ██    ██ ██   ███
            ██  ██ ██ ██      ██ ███ ██     ██      ██  ██  ██ ██      ██      ██    ██    ██    ██      ██          ██   ██ ██ ██   ██ ██      ██    ██ ██    ██
            ██   ████ ███████  ███ ███      ███████ ██      ██ ██      ███████  ██████     ██    ███████ ███████     ██████  ██ ██   ██ ███████  ██████   ██████
            -->
            <paper-dialog id="NewEmployee" class="dropdown-content" entry-animation="scale-up-animation" exit-animation="fade-out-animation"
                with-backdrop modal>

                <h2>New Employee</h2>

                <paper-dialog-scrollable>
                    <div class="">
                        <paper-input autofocus id="name-New" invalid="{{ValNewPhone}}" auto-validate='true' required='true' label="Name" value="{{NewEmp.employee_name}}"></paper-input>
                        <paper-input id="email-New" label="Email" value="{{NewEmp.employee_email}}"></paper-input>
                        <gold-phone-input auto-validate="true" invalid="{{ValNewPhone}}" prevent-invalid-input="true" id="phone-New" label="Phone Number"
                            value="{{NewEmp.employee_phone}}"></gold-phone-input>
                        <paper-input id="ABC-New" label="ABC Expiration Date" always-float-label type="date" value="{{NewEmp.employee_abc_expiration_date}}"></paper-input>
                        <paper-input label="ABC Book Location" id="BookLocation-New" value="{{NewEmp.employee_abc_book_location}}"></paper-input>
                    </div>
                    <div class="center horizontal">
                        <paper-card heading="AM" class=" vertical center" style="margin:5px;">
                            <div class="card-content layout vertical">
                                <paper-checkbox checked="{{NewEmp.shifts_am.1}}">Monday</paper-checkbox>
                                <paper-checkbox checked="{{NewEmp.shifts_am.2}}">Tuesday</paper-checkbox>
                                <paper-checkbox checked="{{NewEmp.shifts_am.3}}">Wednesday</paper-checkbox>
                                <paper-checkbox checked="{{NewEmp.shifts_am.4}}">Thursday</paper-checkbox>
                                <paper-checkbox checked="{{NewEmp.shifts_am.5}}">Friday</paper-checkbox>
                                <paper-checkbox checked="{{NewEmp.shifts_am.6}}">Saturday</paper-checkbox>
                                <paper-checkbox checked="{{NewEmp.shifts_am.7}}">Sunday</paper-checkbox>
                            </div>
                        </paper-card>
                        <paper-card heading="PM" class=" vertical center" style="margin:5px;">
                            <div class="card-content layout vertical">
                                <paper-checkbox checked="{{NewEmp.shifts_pm.1}}">Monday</paper-checkbox>
                                <paper-checkbox checked="{{NewEmp.shifts_pm.2}}">Tuesday</paper-checkbox>
                                <paper-checkbox checked="{{NewEmp.shifts_pm.3}}">Wednesday</paper-checkbox>
                                <paper-checkbox checked="{{NewEmp.shifts_pm.4}}">Thursday</paper-checkbox>
                                <paper-checkbox checked="{{NewEmp.shifts_pm.5}}">Friday</paper-checkbox>
                                <paper-checkbox checked="{{NewEmp.shifts_pm.6}}">Saturday</paper-checkbox>
                                <paper-checkbox checked="{{NewEmp.shifts_pm.7}}">Sunday</paper-checkbox>
                            </div>
                        </paper-card>
                    </div>
                </paper-dialog-scrollable>
                <div class="buttons">
                    <paper-button dialog-dismiss>Cancel</paper-button>
                    <paper-button id="BtnNewEmpPlus" disabled$="{{ValNewPhone}}" on-tap="InsertEmployee">Submit + New</paper-button>
                    <paper-button id="BtnNewEmp" disabled$="{{ValNewPhone}}" on-tap="InsertEmployee" dialog-confirm>Submit + Close</paper-button>
                </div>
            </paper-dialog>

            <!-- Phone list iframe (used to open page and print list) -->
            <iframe id="PrintFrame" src="" hidden></iframe>

            <!--

            ███████  █████  ██████
            ██      ██   ██ ██   ██
            █████   ███████ ██████
            ██      ██   ██ ██   ██
            ██      ██   ██ ██████

            -->
            <div id="MenuFab" class="MenuButton">
                <paper-fab-speed-dial direction="top">
                    <paper-fab style="margin-bottom:2px;" icon="menu" success class="dropdown-trigger"></paper-fab>
                    <div class="dropdown-content">
                        <paper-fab title="Employee Shift Report" mini icon="icons:assessment" info on-tap="PrintReport"></paper-fab>
                        <paper-fab mini info icon="communication:phone" title="Print Phone List" on-tap="PrintPhone"></paper-fab>
                        <paper-fab mini warning icon="add" title="New Employee" onclick="NewEmployee.open()" class="dropdown-trigger"></paper-fab>
                </paper-fab-speed-dial>
                </div>
            </div>

            <div id="SaveFab" class="SaveButton closed">
                <paper-fab on-tap="UpdateInfo" style="float:right; margin-bottom:2px;" success icon="save" class="dropdown-trigger"></paper-fab>
            </div>



            <div id="CancelFab" class="CancelButton closed">
                <paper-fab style="margin-bottom:2px;" onclick="CancelChanges.open()" mini icon="clear" class="dropdown-trigger" error></paper-fab>
            </div>


            <paper-dialog id="CancelChanges" entry-animation="scale-up-animation" exit-animation="scale-down-animation" modal with-backdrop>
                <h2>Are you sure you want to cancel changes?</h2>
                <p style="text-align:center;">
                    Your data has NOT been saved!</br>
                    If you continue, all changes will be lost!
                </p>
                <div class="buttons">
                    <paper-button dialog-dismiss autofocus>No</paper-button>
                    <paper-button dialog-confirm on-tap="clearChanges">Yes</paper-button>
                </div>
            </paper-dialog>


            <!--

            ██ ██████   ██████  ███    ██      █████       ██  █████  ██   ██
            ██ ██   ██ ██    ██ ████   ██     ██   ██      ██ ██   ██  ██ ██
            ██ ██████  ██    ██ ██ ██  ██     ███████      ██ ███████   ███
            ██ ██   ██ ██    ██ ██  ██ ██     ██   ██ ██   ██ ██   ██  ██ ██
            ██ ██   ██  ██████  ██   ████     ██   ██  █████  ██   ██ ██   ██

            -->
            <!-- Get employees from server and put them in the {{Employees}} object-->
            <iron-ajax id="GetData" handle-as="json" on-error="GetRequestFail" method="GET" url="/api/employees" on-response="setEmployees"
                on-response="LoadingComplete" content-type="application/json">
            </iron-ajax>

            <!-- Multipurpose ajax object for JSON_Employees.php -->
            <iron-ajax id="AjaxReq" on-error="RequestFail" handle-as="json" on-response="RequestComplete">
            </iron-ajax>
    </template>

    <!--
         ██  █████  ██    ██  █████  ███████  ██████ ██████  ██ ██████  ████████
         ██ ██   ██ ██    ██ ██   ██ ██      ██      ██   ██ ██ ██   ██    ██
         ██ ███████ ██    ██ ███████ ███████ ██      ██████  ██ ██████     ██
    ██   ██ ██   ██  ██  ██  ██   ██      ██ ██      ██   ██ ██ ██         ██
     █████  ██   ██   ████   ██   ██ ███████  ██████ ██   ██ ██ ██         ██
    -->
    <script>
        // basic JS
        hoverOver = function (srcElement) {
            srcElement.elevation = 3;
        };

        hoverOut = function (srcElement) {
            srcElement.elevation = 1;
        };

        function deleteClick(e) {
            var button = e.target;
            while (!button.hasAttribute('data-dialog') && button !== document.body) {
                button = button.parentElement;
            }

            if (!button.hasAttribute('data-dialog')) {
                return;
            }
            document.getElementById('did').innerHTML = button.getAttribute('id');
            var id = button.getAttribute('data-dialog');
            var dialog = document.getElementById(id);
            if (dialog) {
                dialog.open();
            }
        }
        // End Basic JS
        //http://stackoverflow.com/questions/4994201/is-object-empty
        function isEmpty(obj) {
            // null and undefined are "empty"
            if (obj == null) return true;

            // Assume if it has a length property with a non-zero value
            // that that property is correct.
            if (obj.length && obj.length > 0) return false;
            if (obj.length === 0) return true;

            // Otherwise, does it have any properties of its own?
            // Note that this doesn't handle
            // toString and toValue enumeration bugs in IE < 9
            for (var key in obj) {
                if (hasOwnProperty.call(obj, key)) return false;
            }

            return true;
        }

        // Polymer JS Calls
        Polymer({
            is: 'Edit-Employees',
            properties: {
                DeleteID: {
                    type: String
                },
                SearchHidden: {
                    type: Boolean,
                    value: true
                },
                Employees: {
                    type: Array,
                    notify: true,
                    reflectToAttribute: true
                },
                NewEmp: {
                    type: Array,
                    notify: true
                },
                ChangedData: {
                    type: Array,
                    notify: true,
                    value: []
                }
            },
            observers: [
                'OnChange(Employees.data.*)'
            ],
            ready: function () {
                this.$.spinner.active = true;
                app.PageLoading = false;
                // this.async(function() { // // ajax load employees // this.$.GetData.generateRequest(); // }, 400);
                this.$.GetData.generateRequest();
                this.setNewEmp();
            },
            OnChange: function (cng) {

                if (cng) {
                    var splitPath = cng.path.split(".");
                    if (splitPath[2] != null) {
                        this.$.MenuFab.classList.add('closed');
                        this.$.CancelFab.classList.remove('closed');
                        this.$.SaveFab.classList.remove('closed');
                        if (this.ChangedData.indexOf(splitPath[2]) == -1) {
                            this.ChangedData.push(splitPath[2]);
                        }
                    }
                }

            },
            clearChanges: function () {
                this.$.MenuFab.classList.remove('closed');
                this.$.CancelFab.classList.add('closed');
                this.$.SaveFab.classList.add('closed');
                this.ChangedData = [];
                this.$.GetData.generateRequest();
            },

            setNewEmp: function () {
                this.NewEmp = {
                    employee_name: '',
                    employee_email: '',
                    employee_phone: '',
                    employee_abc_expiration_date: '',
                    employee_abc_book_location: '',
                    shifts_am: {
                        1: false,
                        2: false,
                        3: false,
                        4: false,
                        5: false,
                        6: false,
                        7: false
                    },
                    shifts_pm: {
                        1: false,
                        2: false,
                        3: false,
                        4: false,
                        5: false,
                        6: false,
                        7: false
                    }
                }
            },

            setEmployees: function (data) {
                this.Employees = [];
                this.Employees = data.detail.response;
                this.$.spinner.active = false;
            },

            UpdateInfo: function () {
                var data = [];
                this.$.spinner.active = true;
                this.ChangedData.forEach(obj => {
                    data.push(this.get('Employees.data.' + obj));
                });
                this.$.AjaxReq.method = 'PUT';
                this.$.AjaxReq.contentType = 'application/json';
                this.$.AjaxReq.url = '/api/employees';

                data.forEach(obj => {
                    for (var i in obj) {
                        if (obj[i] === "") {
                            obj[i] = null;
                        }
                    }
                });

                this.$.AjaxReq.body = data;
                // Set toast text
                app.$.toast.text = "All records have been updated";
                // Acually make post
                this.$.AjaxReq.generateRequest();
            },

            Delete: function (e) {
                this.$.spinner.active = true;
                DeleteID = document.getElementById("did").innerHTML;
                this.$.AjaxReq.method = 'DELETE';
                this.$.AjaxReq.url = '/api/employees/' + DeleteID;
                this.$.AjaxReq.generateRequest();
                app.$.toast.text = "Employee has been deleted.";
            },

            InsertEmployee: function (e) {

                var ret = JSON.stringify(this.NewEmp);
                ret = ret.replace(/""/g, null)

                this.$.AjaxReq.method = 'POST';
                this.$.AjaxReq.contentType = 'application/json';
                this.$.AjaxReq.url = '/api/employees';
                // this.$.postAjax.body = {"Request":"UPDATEINFO","id":id,"employee":name,"Email":email,"Phone":phone, "ABC":ABC, "BookLocation":BookLocation};
                this.$.AjaxReq.body = ret;
                // Set toast text
                app.$.toast.text = this.NewEmp.employee_name + " has been added to the schedule";
                // Acually make post
                this.$.AjaxReq.generateRequest();
            },

            computeFilter: function (string) {
                if (!string) {
                    // set filter to null to disable filtering
                    return null;
                } else {
                    // return a filter function for the current search string
                    string = string.toLowerCase();
                    return function (emp) {

                        var Name = emp.employee_name.toLowerCase();
                        var Email = '';
                        if (emp.employee_email != null) {
                            var Email = emp.employee_email.toLowerCase();
                        }
                        var ABC = String(emp.employee_abc_book_location);
                        return (Name.indexOf(string) != -1 || Email.indexOf(string) != -1 || ABC.indexOf(
                            string) != -1);
                    };
                }
            },
            PrintPhone: function () {
                this.$.PrintFrame.src = "/api/employees/phoneList?rand=" + Math.round(Math.random() *
                    10000000);
            },
            PrintReport: function () {
                this.$.PrintFrame.src = "/api/employees/report?rand=" + Math.round(Math.random() * 10000000);
            },
            LoadingComplete: function () {
                this.$.spinner.active = false;
                app.PageLoading = false;
            },
            GetRequestFail: function () {
                app.$.toast.text = "Unable to connect to server, trying again in 5 seconds.";
                app.$.toast.show();
                this.$.spinner.active = false;
                this.async(function () {
                    this.$.spinner.active = true;
                    this.$.GetData.generateRequest();
                }, 5000);

            },
            RequestFail: function (e) {
                app.$.noConnection.open()
                this.$.spinner.active = false;
                console.log(e)
            },
            RequestComplete: function (data) {
                if (data.detail.response.result != 'success') {
                    app.$.toast.text = "error: " + data.detail.response.log;
                } else {
                    this.$.MenuFab.classList.remove('closed');
                    this.$.CancelFab.classList.add('closed');
                    this.$.SaveFab.classList.add('closed');
                    this.ChangedData = [];
                    this.NewEmp = [];
                    this.setNewEmp();
                    this.$.GetData.generateRequest();
                }
                app.$.toast.show();
                this.$.spinner.active = false;
            }
        });
    </script>
    <!-- End JavaScript -->
</dom-module>