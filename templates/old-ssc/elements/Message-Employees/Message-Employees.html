<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="Message-Employees">
	<!--<script src='//cdn.tinymce.com/4/tinymce.min.js'></script>-->
	<script src="https://cdn.tiny.cloud/1/no-api-key/tinymce/5/tinymce.min.js" referrerpolicy=""origin"></script>
	<template>
		<paper-toolbar>
			<iron-icon style="" icon="icons:mail"></iron-icon>
			<div class="title" style="margin-left:10px;">Email All Employees</div>
			<paper-spinner style="margin-left:250px; position: absolute;" id="spinner"></paper-spinner>
		</paper-toolbar>
		<paper-input error-message="Message subject is required!" label="Message Subject" id="Subject"></paper-input>
		</br>

		<span id="editorEmpty" style="color:red;" class="error hidden">Message body is required!</span>
		<textarea id="Editor" class="TMCE" cols="204" rows="75">
		</textarea>
		<div style="z-index:20;position:fixed; bottom:5%;right:5%;">
			<paper-fab success icon="send" elevation="3" on-click="SendMessage"></paper-fab>
			<paper-tooltip position="left">Send Message</paper-tooltip>
		</div>

		<iron-ajax id="SendEmail" handle-as="json" method="POST" url="/api/email" on-response="RequestComplete" content-type="application/json">
		</iron-ajax>
	</template>

	<script>
		Polymer({
			is: 'Message-Employees',
			ready: function () {
				app.PageLoading = false;
			},

			SendMessage: function () {
				if (this.$.Subject.value == '') {
					this.$.Subject.invalid = true;
				} else if (tinyMCE.get('Editor').getContent() == '') {
					this.$.editorEmpty.classList.remove('hidden');

				} else {
					this.$.Subject.invalid = false;
					this.$.editorEmpty.classList.add('hidden');
					this.$.spinner.active = true;
					var message = {
						subject: this.$.Subject.value,
						body: tinyMCE.get('Editor').getContent()
					}
					app.$.toast.text = "Messages sent";
					this.$.SendEmail.body = message;
					this.$.SendEmail.generateRequest();
				}

			},
			RequestComplete: function (data) {
				if (data.detail.response.result != 'success') {
					app.$.toast.text = "error: " + data.detail.response.log;
				} else {
					this.$.spinner.active = false;
				}
				app.$.toast.show();

			},
			postComplete: function () {
				app.$.toast.show();
				tinyMCE.get('Editor').setContent('');
			}
		});
	</script>
</dom-module>